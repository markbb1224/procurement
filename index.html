<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¦ é€²è²¨æ¸…å–®</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap');
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Noto Sans TC', sans-serif; background: #F5F0E8; color: #2C2416; min-height: 100vh; }

  .app { max-width: 860px; margin: 0 auto; padding: 36px 20px 80px; }

  h1 { font-size: 22px; font-weight: 700; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
  h1 small { font-size: 11px; color: #A8967A; font-weight: 400; font-family: 'JetBrains Mono'; display: flex; align-items: center; gap: 5px; }
  .dot { width: 7px; height: 7px; border-radius: 50%; background: #6B8C42; display: inline-block; animation: pulse 2s infinite; }
  .dot.off { background: #C4B89A; animation: none; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .sec-label {
    font-size: 11px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
    color: #7A6B55; padding-bottom: 10px; border-bottom: 2px solid #D4C9B0;
    display: flex; align-items: center; gap: 8px;
  }
  .badge { font-family: 'JetBrains Mono'; background: #8B7355; color: #fff; border-radius: 10px; padding: 2px 9px; font-size: 10px; }
  .badge.g { background: #6B8C42; }

  .tbl-wrap { background: #FFFDF7; border-radius: 0 0 12px 12px; box-shadow: 0 2px 16px #8B7D6020; overflow: hidden; }
  table { width: 100%; border-collapse: collapse; }
  thead tr { background: #EDE8DF; border-bottom: 2px solid #D4C9B0; }
  thead th { font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: #8B7D60; padding: 10px 14px; text-align: left; }
  thead th.c { text-align: center; }
  tbody tr { border-bottom: 1px solid #EDE8DF; transition: background 0.12s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: #F0EBE0; }
  tbody tr.done { opacity: 0.45; background: #F5F0E8; }
  tbody tr.done .item-td { text-decoration: line-through; color: #A8967A; }
  td { padding: 0; vertical-align: middle; }
  td.c { text-align: center; }

  .date-td { font-family: 'JetBrains Mono'; font-size: 12px; color: #A8967A; padding: 0 6px 0 14px; white-space: nowrap; width: 54px; }

  input.ed {
    background: none; border: none; outline: none;
    font-family: 'Noto Sans TC', sans-serif; font-size: 14px; color: #2C2416;
    width: 100%; padding: 11px 14px; transition: background 0.15s; border-radius: 4px;
  }
  input.ed:focus { background: #EDE8DF; box-shadow: 0 0 0 2px #3B5BDB33; }
  input.ed::placeholder { color: #C4B89A; }
  input.ed.mono { font-family: 'JetBrains Mono'; font-size: 13px; color: #475569; }

  .chk-wrap { display: flex; align-items: center; justify-content: center; padding: 8px 14px; }
  .chk {
    width: 24px; height: 24px; border: 2px solid #D4C9B0; border-radius: 6px;
    background: #FFFDF7; cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; flex-shrink: 0; user-select: none;
  }
  .chk:hover { border-color: #6B8C42; background: #EDF2E0; transform: scale(1.12); }
  .chk.on { background: #6B8C42; border-color: #6B8C42; }
  .chk svg { display: none; }
  .chk.on svg { display: block; }

  .del { background: none; border: none; color: #C4B89A; cursor: pointer; font-size: 18px; padding: 6px 12px; border-radius: 4px; transition: all 0.12s; line-height: 1; }
  .del:hover { color: #E03131; background: #FFF0F0; }

  .add-btn {
    display: block; width: 100%; background: #FFFDF7; border: none; border-top: 1px dashed #D4C9B0;
    text-align: left; padding: 12px 14px; font-size: 13px; color: #A8967A;
    cursor: pointer; font-family: 'Noto Sans TC', sans-serif; transition: all 0.15s; border-radius: 0 0 12px 12px;
  }
  .add-btn:hover { color: #7A6540; background: #EDE8DF; }

  hr { border: none; border-top: 2px dashed #D4C9B0; margin: 32px 0; }
  .empty { padding: 18px 14px; font-size: 13px; color: #C4B89A; }

  /* Share bar */
  .share-bar {
    background: #FFFDF7; border: 1.5px solid #D4C9B0; border-radius: 10px;
    padding: 12px 16px; margin-bottom: 24px; display: flex; align-items: center; gap: 10px;
    font-size: 13px; color: #7A6B55;
  }
  .share-bar strong { color: #7A6540; }
  .share-url {
    flex: 1; font-family: 'JetBrains Mono'; font-size: 11px; color: #7A6540;
    background: #EDE8DF; border: none; outline: none; border-radius: 6px;
    padding: 6px 10px; cursor: text; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .copy-btn {
    background: #8B7355; color: #fff; border: none; border-radius: 6px;
    padding: 7px 14px; font-size: 12px; cursor: pointer; font-family: 'Noto Sans TC', sans-serif;
    transition: background 0.15s; white-space: nowrap;
  }
  .copy-btn:hover { background: #7A6345; }
  .copy-btn.done-copy { background: #6B8C42; }
</style>
</head>
<body>
<div class="app">
  <h1>
    ğŸ“¦ é€²è²¨æ¸…å–®
    <small><span class="dot off" id="dot"></span><span id="sync-label">é€£ç·šä¸­â€¦</span></small>
  </h1>

  <div class="share-bar">
    ğŸ“ åˆ†äº«æ­¤é€£çµçµ¦å“¡å·¥ï¼Œå¤§å®¶åŒæ­¥ç·¨è¼¯ï¼š
    <input class="share-url" id="share-url" readonly>
    <button class="copy-btn" id="copy-btn" onclick="copyLink()">è¤‡è£½é€£çµ</button>
  </div>

  <div class="sec-label">å¾…é€²è²¨ <span class="badge" id="pending-count">0</span></div>
  <div class="tbl-wrap">
    <table>
      <thead><tr><th>æ—¥æœŸ</th><th>å“é …</th><th>æ•¸é‡ï¼è¦æ ¼</th><th>å‚™è¨»</th><th class="c">å·²é€²è²¨</th><th></th></tr></thead>
      <tbody id="pending-body"></tbody>
    </table>
    <button class="add-btn" onclick="addRow()">ï¼‹ æ–°å¢å“é …</button>
  </div>

  <hr>

  <div class="sec-label">å·²é€²è²¨ <span class="badge g" id="done-count">0</span></div>
  <div class="tbl-wrap">
    <table>
      <thead><tr><th>æ—¥æœŸ</th><th>å“é …</th><th>æ•¸é‡ï¼è¦æ ¼</th><th>å‚™è¨»</th><th class="c">å·²é€²è²¨</th><th></th></tr></thead>
      <tbody id="done-body"></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script>
// Get or create room ID from URL
const params = new URLSearchParams(location.search);
let room = params.get("room");
if (!room) {
  room = Math.random().toString(36).slice(2, 10);
  const url = new URL(location.href);
  url.searchParams.set("room", room);
  history.replaceState({}, "", url);
}

// Show share URL
const shareUrl = location.href;
document.getElementById("share-url").value = shareUrl;

function copyLink() {
  navigator.clipboard.writeText(shareUrl);
  const btn = document.getElementById("copy-btn");
  btn.textContent = "âœ“ å·²è¤‡è£½";
  btn.classList.add("done-copy");
  setTimeout(() => { btn.textContent = "è¤‡è£½é€£çµ"; btn.classList.remove("done-copy"); }, 2000);
}

// Init Gun
const gun = Gun(["https://gun-manhattan.herokuapp.com/gun", "https://gundb-relay-mlmr.onrender.com/gun"]);
const db = gun.get("procurement-" + room);

let rows = {};
let renderTimer = null;

// Connection status (simple heuristic)
let connected = false;
function setConnected(v) {
  connected = v;
  document.getElementById("dot").className = "dot" + (v ? "" : " off");
  document.getElementById("sync-label").textContent = v ? "å³æ™‚åŒæ­¥ä¸­" : "é€£ç·šä¸­â€¦";
}
setTimeout(() => setConnected(true), 2000);

function fmtDate(ts) {
  if (!ts) return "";
  const d = new Date(ts);
  return `${d.getMonth()+1}/${d.getDate()}`;
}

// Listen for all row changes
db.map().on(function(data, id) {
  if (id === "_") return;
  if (data === null || data === undefined) {
    delete rows[id];
  } else {
    rows[id] = { ...rows[id], ...data, id };
  }
  scheduleRender();
});

function scheduleRender() {
  clearTimeout(renderTimer);
  renderTimer = setTimeout(render, 80);
}

function render() {
  const focusedId = document.activeElement?.id;
  const selStart = document.activeElement?.selectionStart;
  const selEnd = document.activeElement?.selectionEnd;

  const all = Object.values(rows).filter(r => r && r.id && !r._deleted);
  const pending = all.filter(r => !r.done).sort((a,b) => (a.createdAt||0)-(b.createdAt||0));
  const done = all.filter(r => r.done).sort((a,b) => (a.createdAt||0)-(b.createdAt||0));

  document.getElementById("pending-count").textContent = pending.length;
  document.getElementById("done-count").textContent = done.length;

  renderTable("pending-body", pending);
  renderTable("done-body", done);

  // Restore focus
  if (focusedId) {
    const el = document.getElementById(focusedId);
    if (el) {
      el.focus();
      try { el.setSelectionRange(selStart, selEnd); } catch(e) {}
    }
  }
}

function renderTable(tbodyId, rowList) {
  const tbody = document.getElementById(tbodyId);
  tbody.innerHTML = "";
  if (rowList.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6"><div class="empty">' +
      (tbodyId === "pending-body" ? "æ²’æœ‰å¾…é€²è²¨é …ç›®" : "å°šç„¡ç´€éŒ„") + '</div></td></tr>';
    return;
  }
  rowList.forEach(row => tbody.appendChild(makeRow(row)));
}

function makeRow(row) {
  const tr = document.createElement("tr");
  if (row.done) tr.classList.add("done");

  // Date
  const dateTd = document.createElement("td");
  dateTd.className = "date-td";
  dateTd.textContent = fmtDate(row.createdAt);
  tr.appendChild(dateTd);

  // Item
  const itemTd = document.createElement("td");
  itemTd.className = "item-td";
  itemTd.appendChild(makeInput("item", row, "å“é …åç¨±â€¦", false));
  tr.appendChild(itemTd);

  // Qty
  const qtyTd = document.createElement("td");
  qtyTd.appendChild(makeInput("qty", row, "æ•¸é‡ï¼è¦æ ¼", true));
  tr.appendChild(qtyTd);

  // Note
  const noteTd = document.createElement("td");
  noteTd.appendChild(makeInput("note", row, "å‚™è¨»", false));
  tr.appendChild(noteTd);

  // Checkbox
  const chkTd = document.createElement("td");
  chkTd.className = "c";
  const wrap = document.createElement("div");
  wrap.className = "chk-wrap";
  const chk = document.createElement("div");
  chk.className = "chk" + (row.done ? " on" : "");
  chk.innerHTML = `<svg width="12" height="9" viewBox="0 0 12 9" fill="none"><path d="M1 4L4.5 7.5L11 1" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  chk.onclick = () => db.get(row.id).put({ done: !row.done });
  wrap.appendChild(chk);
  chkTd.appendChild(wrap);
  tr.appendChild(chkTd);

  // Delete
  const delTd = document.createElement("td");
  delTd.className = "c";
  const delBtn = document.createElement("button");
  delBtn.className = "del";
  delBtn.textContent = "Ã—";
  delBtn.onclick = () => {
    db.get(row.id).put({ _deleted: true, item: "", qty: "", note: "" });
    delete rows[row.id];
    scheduleRender();
  };
  delTd.appendChild(delBtn);
  tr.appendChild(delTd);

  return tr;
}

function makeInput(field, row, placeholder, mono) {
  const input = document.createElement("input");
  input.className = "ed" + (mono ? " mono" : "");
  input.placeholder = placeholder;
  input.value = row[field] || "";
  input.id = `${field}-${row.id}`;
  let saveTimer;
  input.addEventListener("input", e => {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => db.get(row.id).put({ [field]: e.target.value }), 400);
  });
  input.addEventListener("keydown", e => {
    if (e.key !== "Enter") return;
    e.preventDefault();
    const seq = ["item","qty","note"];
    const ni = seq.indexOf(field) + 1;
    if (ni < seq.length) document.getElementById(`${seq[ni]}-${row.id}`)?.focus();
    else addRow();
  });
  return input;
}

window.addRow = function() {
  const id = Date.now().toString(36) + Math.random().toString(36).slice(2);
  const data = { item: "", qty: "", note: "", done: false, createdAt: Date.now() };
  rows[id] = { ...data, id };
  db.get(id).put(data);
  scheduleRender();
  setTimeout(() => document.getElementById("item-" + id)?.focus(), 100);
};

// Start with one empty row if empty
setTimeout(() => {
  if (Object.keys(rows).length === 0) addRow();
}, 1500);
</script>
</body>
</html>
